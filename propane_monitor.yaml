
substitutions:
  # If you are interested in this project, and you don't have any Mopeka sensors available,
  # change 'sub_show_dev' to "true".  This will enable components in the web portal that will allow
  # you to test out the different features as if you were connected to an actual sensor.  This is
  # very helpful if you are not at the same location as your sensors (for example, working on this 
  # as a winter project when your RV is in storage)
  sub_show_dev:                               "true"
  # ---------------------------------------------------------------------------
  # Project Specific Substitutions
  sub_text_devicename:                        "PropaneMonitor" 
  sub_esphome_name:                           propanemonitor
  sub_code_version:                           "2022.12.9"
  # Network and service related substitutions
  sub_wifi_ssid1:                             !secret esp_wifi_ssid1
  sub_wifi_password1:                         !secret esp_wifi_pass1
  # Fast connect is only available when a single SSID is used.  True or False
  sub_wifi_fast_connect:                      "true"                  
  sub_wifi_ap_password:                       !secret esp_ap_psk
  sub_web_server_port:                        !secret esp_http_server_port
  sub_web_server_auth_user:                   !secret esp_http_user
  sub_web_server_auth_password:               !secret esp_http_pass
  sub_api_password:                           !secret esp_api_pass
  sub_ota_safe_mode:                          "true"
  sub_ota_password:                           !secret esp_ota_pass

  sub_sensor1_name:                           "Right Tank"
  sub_sensor1_tank_type:                      "30LB_V" 
  sub_sensor1_mac:                            "FC:9A:FC:36:40:39" #"F8:DE:AA:BF:F7:0A" # Lippert Sensor
  #sub_sensor1_mac:                            "F6:CC:9C:06:F6:F9" # Mopeka Sensor
  sub_sensor1_id:                             "tank1"

  sub_sensor2_name:                           "Left Tank"
  sub_sensor2_tank_type:                      "30LB_V"
  sub_sensor2_mac:                            "C4:97:8F:93:3A:1B" #"CC:9C:31:1E:75:8D"
  sub_sensor2_id:                             "tank2"

  ## Used for the configuration of the display screens
  sub_page1_title:                            "Propane Levels"
  sub_page2_title:                            "Sensor Conditions"
#*****************************************************************************#
esphome:
  name:                                       ${sub_esphome_name}
  comment:                                    "Lippert integration with mopeka component"
  project:
    name:                                     "rperciaccante.mopeka_pro_check"
    version:                                  ${sub_code_version}
  includes:
    - tdisplays3/tft_espi_display.h
    - tdisplays3/Free_Fonts.h
  libraries:
    - SPI
    - FS
    - SPIFFS
    - tdisplays3=https://github.com/landonr/lilygo-tdisplays3-esphome.git
  on_boot:               
    priority:                                 600
    then:
      - lambda: |-
          display->tft.fillScreen(TFT_BLACK);
      - delay:                                200ms
      - script.execute:                       on_boot
#*****************************************************************************#
esp32:
  board: esp32s3box 
  variant: esp32s3
  framework:
      type: arduino
      version: 2.0.3
      platform_version: 5.0.0
#*****************************************************************************#
custom_component:
  lambda: |-
      App.register_component(display);
      return {display};
  id: displayComponent

#*****************************************************************************#
# Since the ESPHome component does not support the Lippert propane sensors 
# natively, this adds support
external_components:
  - source:
      type: git
      url: https://github.com/rperciaccante/esphome/
      ref: mopeka_dev
    components: [ mopeka_pro_check ]
#*****************************************************************************#
# Default is DEBUG, set to WARN to keep things easier to manage installation
# and general use - can be changed as needed  - https://esphome.io/components/logger.html
logger:
  level:                                      WARN
#*****************************************************************************#
# Best practice is to use specific SSID/PASSWD in local secrets.yaml file.
# For more information on the WiFi component: https://esphome.io/components/wifi.html
# In this configuration, it will enable a local hotspot, which you connect to, and pick the 
# WiFi network to connect to.
wifi: 
  # To define specific SSID/PASSD, uncomment the next 3 lines and add the SSID/PASSED to the secrets.yaml file
  networks:
   - ssid:                                    ${sub_wifi_ssid1}                        
     password:                                ${sub_wifi_password1}                       
  ap:                                         # Enable fallback hotspot
    ssid:                                     ${sub_text_devicename} Hotspot
    # To enable a password on the hotspot, uncomment the next line, and add the ap_password to the secrets.yaml file.
    password:                                 ${sub_wifi_ap_password}
#*****************************************************************************#
# This section tells the device to enable a local captive portal which can be used to connect to the device to 
# change network settings or to upload a new firmware.  This is recommended.
captive_portal:
#*****************************************************************************#
ota:
  safe_mode:                                  ${sub_ota_safe_mode}
  password:                                   ${sub_ota_password}
#*****************************************************************************#
api:
  password:                                   ${sub_api_password}
  reboot_timeout:                             0s
#*****************************************************************************#
web_server: 
  include_internal:                           ${sub_show_dev}
  port:                                       ${sub_web_server_port}
  js_include:                                 "./css/V2/www.js"
  js_url:                                     ""
  version:                                    2
  auth:
    username:                                 ${sub_web_server_auth_user}
    password:                                 ${sub_web_server_auth_password}
#*****************************************************************************#
esp32_ble_tracker:
#*****************************************************************************#
interval:
  # Run the errorCheck script every 5 seconds
  - interval:                                 5s
    then:
      - script.execute:                       errorCheck
  # ---------------------------------------------------------------------------
  - interval:                                 10s
    then:
      - script.execute:                       pageRefresh
      - if:
          condition:
            switch.is_on:                     refreshEnabled
          then:
            - number.increment:               pageCurrent

#*****************************************************************************#
# Global Variables
globals:
   - id:                                      displayWelcome
     type:                                    bool
     restore_value:                           no
     initial_value:                           "true"


#*****************************************************************************#
# Binary Sensors                    
binary_sensor:
  - id:                                       deviceShowWelcome
    platform:                                 template
    name:                                     (DEV) State - Show Welcome Message
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 1 Error status
    #   in the web interface
  - id:                                       sensor1HasError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 1
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 1 Battery Error status
    #   in the web interface
  - id:                                       sensor1BattError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 1 Battery
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 1 Bluetooth Signal Error status
    #   in the web interface
  - id:                                       sensor1BTSignalError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 1 BT Signal
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 2 Error status
    #   in the web interface
  - id:                                       sensor2HasError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 2 
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 2 Battery Error status
    #   in the web interface
  - id:                                       sensor2BattError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 2 Battery
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to see the status of the Sensor 1 Bluetooth Signal Error status
    #   in the web interface
  - id:                                       sensor2BTSignalError
    platform:                                 template
    name:                                     (DEV) Error - Sensor 2 Battery
    internal:                                 true
  # ---------------------------------------------------------------------------
  - id:                                       pageNext
    platform:                                 gpio
    pin:
      number:                                 GPIO0
      inverted:                               true
    name:                                     ${sub_text_devicename} Page Next
    internal:                                 true
    on_multi_click:
      - timing:
          - ON for at most 1s
          - OFF for at most 1s
          - ON for at most 1s
          - OFF for at least 0.2s
        then:
          - logger.log: 
              format: "Double Clicked"
              level: warn
          - logger.log:                         
              format:                           "Screen rotation button pressed"
              level:                              WARN
          - script.execute:                     screenTimer
          - switch.toggle:                      refreshEnabled
          - switch.turn_on:                     backlight 
          - script.stop:                        pageRefresh
          - script.execute:                     displayRotationStatus
          - delay:                              3s
          - script.execute:                     pageRefresh
      - timing:
          - ON for 1s to 2s
          - OFF for at least 0.5s
        then:
          - logger.log: 
              format: "Single Long Clicked"
              level: warn

      - timing:
          - ON for at most 1s
          - OFF for at least 0.5s
        then:
          - logger.log: 
              format: "Single Short Clicked"
              level: warn
          - logger.log:                         
              format:                           "Next Page button pressed"
              level:                            WARN
          - script.execute:                     screenTimer
          - switch.turn_on:                     backlight
          - switch.turn_off:                    refreshEnabled
          - number.increment:                   pageCurrent
          - script.execute:                     pageRefresh
    # on_click:
    # - min_length:                             50ms
    #   max_length:                             350ms
    #   then:
    #     - logger.log:                         
    #         format:                           "Next Page button pressed"
    #         level:                            WARN
    #     - script.execute:                     screenTimer
    #     - switch.turn_on:                     backlight
    #     - switch.turn_off:                    refreshEnabled
    #     - number.increment:                   pageCurrent
    #     - script.execute:                     pageRefresh
    # - min_length:                             1000ms
    #   max_length:                             2000ms
    #   then:
    #     - logger.log:                         
    #         format:                           "Screen rotation button pressed"
    #         level:                              WARN
    #     - script.execute:                     screenTimer
    #     - switch.toggle:                      refreshEnabled
    #     - switch.turn_on:                     backlight 
    #     - script.stop:                        pageRefresh
    #     - script.execute:                     displayRotationStatus
    #     - delay:                              3s
    #     - script.execute:                     pageRefresh
    # on_double_click:
    #   - min_length:                           50ms
    #     max_length:                           350ms
    #     then:
    #       - logger.log:                         
    #           format:                         "Double Click"
    #           level:                          WARN
  # ---------------------------------------------------------------------------
  - id:                                       screen
    platform:                                 gpio
    pin:
      number:                                 GPIO14
      inverted:                               true
    name:                                     ${sub_text_devicename} Screen
    internal:                                 true
    on_click:
    - min_length:                             50ms
      max_length:                             350ms
      then:
        - script.execute:                     screenTimer
        - switch.toggle:                      backlight
    - min_length:                             1000ms
      max_length:                             2000ms
      then:
        - script.execute:                     screenTimer
        - switch.turn_on:                     backlight
        - switch.toggle:                      screensaver
        - script.execute:                     displayScreensaverStatus
        - delay:                              3s

#*****************************************************************************#
# Buttons 
button:
  - id:                                       reboot
    platform:                                 restart
    name:                                     ${sub_text_devicename} Device Restart
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to trigger the screensaver timeout
    #   in the web interface
  - id:                                       triggerScreensaver
    platform:                                 template
    name:                                     (DEV) Device - Trigger Screensaver Timeout
    internal:                                 true
    on_press:
      then:
        - script.execute:                     screenTimer
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to refresh the current page view
    #   in the web interface
  - id:                                       rotatePage
    platform:                                 template
    name:                                     (DEV) Page - Refresh Current
    internal:                                 true
    on_press:
      then:
        - script.execute:                     pageRefresh
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to force view of Page 1 (sensor level widgets)
    #   in the web interface
  - id:                                       dev_showPage1
    platform:                                 template
    name:                                     (DEV) Page - Show Page 1
    internal:                                 true
    on_press:
      then:
        - script.execute:                     pageBuild1
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to force view of Page 2 (Sensor Conditions)
    #   in the web interface
  - id:                                       dev_showPage2
    platform:                                 template
    name:                                     (DEV) Page - Show Page 2
    internal:                                 true
    on_press:
      then:
        - script.execute:                     pageBuild2
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to force view of Page 3 (Network Information)
    #   in the web interface
  - id:                                       dev_showPage3
    platform:                                 template
    name:                                     (DEV) Page - Show Page 3
    internal:                                 true
    on_press:
      then:
        - script.execute:                     pageBuild3
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to force view of Rotation Status page
    #   in the web interface
  - id:                                       dev_showScrollStatus
    platform:                                 template
    name:                                     (DEV) Page - Show Scroll Status
    internal:                                 true
    on_press:
      then:
        - script.execute:                     displayRotationStatus
        - number.increment:                   pageCurrent
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to force view of Screensaver Status page
    #   in the web interface
  - id:                                       dev_showScreenSaverStatus
    platform:                                 template
    name:                                     (DEV) Page - Show Screensaver Status
    internal:                                 true
    on_press:
      then:
        - script.execute:                     displayScreensaverStatus

#*****************************************************************************#
# Numbers 
number:
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to change the page currenty displayed on the LCD
    #   in the web interface
  - id:                                       pageCurrent
    platform:                                 template
    name:                                     Current Page
    internal:                                 true
    optimistic:                               true
    initial_value:                            0
    min_value:                                0
    max_value:                                2
    step:                                     1
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 1 level
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor1LPLevel
    platform:                                 template
    name:                                     (DEV) LP Level - Sensor 1
    internal:                                 true
    optimistic:                               true
    initial_value:                            -1
    min_value:                                -1
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor1LPLevel).publish_state(id(dev_sensor1LPLevel).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 2 level in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor2LPLevel
    platform:                                 template
    name:                                     (DEV) LP Level - Sensor 2
    internal:                                 true
    optimistic:                               true
    initial_value:                            -1
    min_value:                                -1
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor2LPLevel).publish_state(id(dev_sensor2LPLevel).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 1 battery level in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor1Batt
    platform:                                 template
    name:                                     (DEV) Battery - Sensor 1 
    internal:                                 true
    optimistic:                               true
    initial_value:                            -1
    min_value:                                -1
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor1Batt).publish_state(id(dev_sensor1Batt).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 2 battery level in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor2Batt
    platform:                                 template
    name:                                     (DEV) Battery - Sensor 2
    internal:                                 true
    optimistic:                               true
    initial_value:                            -1
    min_value:                                -1
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor2Batt).publish_state(id(dev_sensor2Batt).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 1 temperature in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor1Temp
    platform:                                 template
    name:                                     (DEV) Temp - Sensor 1
    internal:                                 true
    optimistic:                               true
    initial_value:                            -50
    min_value:                                -50
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor1Temp).publish_state(id(dev_sensor1Temp).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 2 temperature in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor2Temp
    platform:                                 template
    name:                                     (DEV) Temp - Sensor 2
    internal:                                 true
    optimistic:                               true
    initial_value:                            -50
    min_value:                                -50
    max_value:                                100
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor2Temp).publish_state(id(dev_sensor2Temp).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 1 bluetooth signal level in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor1BTSignal
    platform:                                 template
    name:                                     (DEV) BT Signal - Sensor 1   
    internal:                                 true
    optimistic:                               true
    initial_value:                            1
    min_value:                                -100
    max_value:                                1
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor1BTSignal).publish_state(id(dev_sensor1BTSignal).state);
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will allow you to set the current sensor 2 bluetooth signal level in the web interface
    #   Initial value is set outside acceptable range so as not to impact legitimate sensor levels
    #  ** NOTE ** this sends the value directly to sensor opject to replicate exactly how the device processes values
  - id:                                       dev_sensor2BTSignal
    platform:                                 template
    name:                                     (DEV) BT Signal - Sensor 2
    internal:                                 true
    optimistic:                               true
    initial_value:                            1
    min_value:                                -100
    max_value:                                1
    step:                                     1
    on_value:
      then:
        - lambda: |-
            id(sensor2BTSignal).publish_state(id(dev_sensor2BTSignal).state);

#*****************************************************************************#
# Sensors
sensor:
# ---------------------------------------------------------------------------
  - id:                                       uptime_s
    platform:                                 uptime
    update_interval:                          10s
    internal:                                 true
  # ---------------------------------------------------------------------------
  - id:                                       ${sub_esphome_name}_wifi_signal
    platform:                                 wifi_signal
    name:                                     ${sub_text_devicename} Device WiFi Signal
    unit_of_measurement:                      "dBm"
    device_class:                             "signal_strength"
    state_class:                              "measurement"
    entity_category:                          diagnostic
    update_interval:                          30s
  # ---------------------------------------------------------------------------
  - platform:                                 mopeka_pro_check
    mac_address:                              ${sub_sensor1_mac}
    tank_type:                                ${sub_sensor1_tank_type}
    temperature:
      name:                                   ${sub_text_devicename} ${sub_sensor1_name} Temp
      id:                                     sensor1Temp 
      unit_of_measurement:                    "°F"
      device_class:                           "temperature"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      filters:
        - lambda:                             return x * (9.0/5.0) + 32.0;
      on_value:
        then:
         - lambda: |-
                    float sensorTemp = id(sensor1Temp).state;
                    if ((sensorTemp < -20) || (sensorTemp > 150)) {
                      id(sensor1Temp).state = -99;
                    }
    level:
      name:                                   ${sub_text_devicename} ${sub_sensor1_name} Level
      id:                                     sensor1LPLevel
      unit_of_measurement:                    "%"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      on_value:
        then:
          - sensor.template.publish:
              id:                             sensor1LvlBGColor
              state:    !lambda |- 
                        float checkValue =        id(sensor1LPLevel).state;
                        float redThreshold =      20;
                        float orangeThreshold =   40;
                        float yellowThreshold =   60;
                        float greenThreshold =    80;
                        if (checkValue > 100 || checkValue < 0) {
                          id(sensor1LPLevel).state = -99;
                        }

                        if ((checkValue > redThreshold) && (checkValue <= orangeThreshold)){
                          return display->tft.color565(255, 180, 0);           // orange
                        } else if ((checkValue > orangeThreshold) && (checkValue <= yellowThreshold)){
                          return display->tft.color565(255, 255, 0);           // yellow
                          } else if ((checkValue > yellowThreshold) && (checkValue <= greenThreshold)){
                          return display->tft.color565(180, 255, 0);           // greenyellow
                        } else if ((checkValue > greenThreshold) && (checkValue <= 100)){
                          return display->tft.color565(0, 255, 0);             // green
                        } else {
                            return display->tft.color565(255, 0, 0);           // red
                        } 
    battery_level:
      name:                                   ${sub_text_devicename} ${sub_sensor1_name} Battery
      id:                                     sensor1Batt
      unit_of_measurement:                    "%"
      device_class:                           "battery"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      on_value:
        then:
          - sensor.template.publish:
              id:                             sensor1BattBGColor
              state:    !lambda |- 
                        float checkValue = id(sensor1Batt).state;
                        float greenThreshold = 50;
                        if ((checkValue > 100) || (checkValue < 0)) {
                          id(sensor1Batt).state = -99;
                        } 
                        if ((checkValue >= greenThreshold)) {
                            id(sensor1BattError).publish_state(false);
                            return display->tft.color565(0, 0, 0);             // black
                        } else {
                            id(sensor1BattError).publish_state(true);
                            ESP_LOGW("errorCheck","${sub_sensor1_name} Battery level outside of margins: %.0f", checkValue);
                            return display->tft.color565(255, 0, 0);           // red
                        } 
  # ---------------------------------------------------------------------------
  - platform:                                 mopeka_pro_check
    mac_address:                              ${sub_sensor2_mac}
    tank_type:                                ${sub_sensor2_tank_type}
    temperature:
      name:                                   ${sub_text_devicename} ${sub_sensor2_name} Temp
      id:                                     sensor2Temp
      unit_of_measurement:                    "°F"
      device_class:                           "temperature"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      filters:
        - lambda:                             return x * (9.0/5.0) + 32.0;
      on_value:
        then:
         - lambda: |-
                    float sensorTemp = id(sensor2Temp).state;
                    if ((sensorTemp < -20) || (sensorTemp > 150)) {
                      id(sensor2Temp).state = -99;
                    } 
    level:
      name:                                   ${sub_text_devicename} ${sub_sensor2_name} Level
      id:                                     sensor2LPLevel
      unit_of_measurement:                    "%"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      on_value:
        then:
          - sensor.template.publish:
              id:                             sensor2LvlBGColor
              state:    !lambda |- 
                          float checkValue = id(sensor2LPLevel).state;
                          float redThreshold = 20;
                          float orangeThreshold = 40;
                          float yellowThreshold = 60;
                          float greenThreshold = 80;

                          if ((checkValue > 100) || (checkValue < 0)) {
                            id(sensor2LPLevel).state = -99;
                          } 

                          if ((checkValue > redThreshold) && (checkValue <= orangeThreshold)){
                            return display->tft.color565(255, 180, 0);           // orange
                          } else if ((checkValue > orangeThreshold) && (checkValue <= yellowThreshold)){
                            return display->tft.color565(255, 255, 0);           // yellow
                            } else if ((checkValue > yellowThreshold) && (checkValue <= greenThreshold)){
                            return display->tft.color565(180, 255, 0);           // greenyellow
                          } else if ((checkValue > greenThreshold) && (checkValue <= 100)){
                            return display->tft.color565(0, 255, 0);             // green
                          } else {
                              return display->tft.color565(255, 0, 0);           // red
                          } 
    battery_level:
      name:                                   ${sub_text_devicename} ${sub_sensor2_name} Battery
      id:                                     sensor2Batt
      unit_of_measurement:                    "%"
      device_class:                           "battery"
      state_class:                            "measurement"
      accuracy_decimals:                      0
      on_value:
        then:
          - sensor.template.publish:
              id:                             sensor2BattBGColor
              state:    !lambda |- 
                float checkValue = id(sensor2Batt).state;
                float greenThreshold = 50;

                if ((checkValue > 100) || (checkValue < 0)) {
                      id(sensor2Batt).state = -99;
                    } 

                if ((checkValue >= greenThreshold)) {
                    id(sensor2BattError).publish_state(false);
                    return display->tft.color565(0, 0, 0);             // black
                } else {
                    id(sensor2BattError).publish_state(true);
                    ESP_LOGW("errorCheck","${sub_sensor2_name} Battery level outside of margins: %.0f", checkValue);
                    return display->tft.color565(255, 0, 0);           // red
                } 
          - script.execute:                   errorCheck
  # ---------------------------------------------------------------------------
  - id:                                       sensor1BTSignal
    platform:                                 ble_rssi
    mac_address:                              ${sub_sensor1_mac}
    name:                                     ${sub_text_devicename} ${sub_sensor1_name} BLE RSSI
    unit_of_measurement:                      "dBm"
    device_class:                             "signal_strength"
    state_class:                              "measurement"
    entity_category:                          diagnostic
    accuracy_decimals:                        0
    icon:                                     mdi:signal
    on_value:
      then:
        - sensor.template.publish:
            id:     sensor1BTSignalBGColor
            state:    !lambda |- 
                        float checkValue = id(sensor1BTSignal).state;
                        float redThreshold = -80;

                        if ((checkValue > redThreshold) && (checkValue < 0)) {
                            id(sensor1BTSignalError).publish_state(false);
                            return display->tft.color565(0, 0, 0);             // black
                        } else {
                            id(sensor1BTSignalError).publish_state(true);
                            ESP_LOGW("errorCheck","${sub_sensor1_name} BLE RSSI level outside of margins: %.0f", checkValue);
                            return display->tft.color565(255, 0, 0);           // red
                        } 
        - script.execute:                     errorCheck
  # ---------------------------------------------------------------------------
  - id:                                       sensor2BTSignal
    platform:                                 ble_rssi
    mac_address:                              ${sub_sensor2_mac}
    name:                                     ${sub_text_devicename} ${sub_sensor2_name} BLE RSSI
    unit_of_measurement:                      "dBm"
    device_class:                             "signal_strength"
    state_class:                              "measurement"
    entity_category:                          diagnostic      
    accuracy_decimals:                        0      
    icon:                                     mdi:signal
    on_value:
      then:
        - sensor.template.publish:
            id:     sensor2BTSignalBGColor
            state:    !lambda |- 
                        float checkValue = id(sensor2BTSignal).state;
                        float redThreshold = -80;

                        if ((checkValue < -98) || (checkValue >= 0)) {
                          id(sensor2BTSignal).state = -99;
                        } 

                        if ((checkValue > redThreshold) && (checkValue < 0)) {
                            id(sensor2BTSignalError).publish_state(false);
                            return display->tft.color565(0, 0, 0);             // black
                        } else {
                            id(sensor2BTSignalError).publish_state(true);
                            ESP_LOGW("errorCheck","${sub_sensor2_name} BLE RSSI level outside of margins: %.0f", checkValue);
                            return display->tft.color565(255, 0, 0);           // red
                        } 
        - script.execute:                     errorCheck
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will display the background color used for the sensor 1 level widget
    #   in the web interface
  - id:                                       sensor1LvlBGColor
    platform:                                 template
    name:                                     (DEV) Display - Sensor 1 LP Level BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------  
    # Visible ONLY in the web portal, this will display the background color used for the sensor 2 level widget
    #   in the web interface
  - id:                                       sensor1BattBGColor
    platform:                                 template
    name:                                     (DEV) Display - Sensor 1 Battery BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------   
    # Visible ONLY in the web portal, this will display the background color used for the sensor 1 bluetooth signal widget
    #   in the web interface
  - id:                                       sensor1BTSignalBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 1 BT Signal BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------   
    # Visible ONLY in the web portal, this will display the background color used for the sensor 1 temp widget
    #   in the web interface
  - id:                                       sensor1TempBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 1 Temp BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------  
    # Visible ONLY in the web portal, this will display the background color used for the sensor 2 bluetooth signal widget
    #   in the web interface
  - id:                                       sensor2LvlBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 2 Level BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------  
    # Visible ONLY in the web portal, this will display the background color used for the sensor 1 battery level widget
    #   in the web interface
  - id:                                       sensor2BattBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 2 Battery BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------
    # Visible ONLY in the web portal, this will display the background color used for the sensor 2 battery level widget
    #   in the web interface
  - id:                                       sensor2BTSignalBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 2 ST Signal BG Color
    internal:                                 true
  # ---------------------------------------------------------------------------   
    # Visible ONLY in the web portal, this will display the background color used for the sensor 2 temp widget
    #   in the web interface
  - id:                                       sensor2TempBGColor
    platform:                                 template
    name:                                     (DEV)  Display - Sensor 2 Temp BG Color
    internal:                                 true

#*****************************************************************************# 
# Scripts 
script:
  - id:                                       on_boot
    then:
      - logger.log:                           "System bootup underway..."
      - switch.turn_on:                       backlight
      - script.execute:                       pageWelcome
      - delay:                                500ms
      - switch.turn_on:                       refreshEnabled
      - script.execute:                       screenTimer
      - delay:                                5s
      - text_sensor.template.publish:
          id:                                 codeVersion
          state:                              ${sub_code_version}
      - lambda: |-
                  id(sensor1HasError).publish_state(false);
                  id(sensor2HasError).publish_state(false);
                  id(sensor1MACAddress).publish_state("${sub_sensor1_mac}"); 
                  id(sensor2MACAddress).publish_state("${sub_sensor2_mac}"); 
  # ---------------------------------------------------------------------------
  - id:                                       screenTimer
    mode:                                     restart
    then:
      - logger.log:
          format:                             "Screensaver timer started"
          level:                              WARN
      - if:
          condition:                 
            switch.is_on:                     screensaver
          then:
            - delay:                          60s
            - logger.log:                     "Screensaver timeout reached"
            - switch.turn_off:                backlight
  # ---------------------------------------------------------------------------
  - id:                                       errorCheck
    mode:                                     restart
    then:
      - lambda: |-
                  if (id(sensor1BattError).state == true || id(sensor1BTSignalError).state == true) {
                      id(sensor1HasError).publish_state(true);
                  } else {
                      id(sensor1HasError).publish_state(false);
                  };
                  if (id(sensor2BattError).state == true || id(sensor2BTSignalError).state == true) {
                      id(sensor2HasError).publish_state(true);
                  } else {
                      id(sensor2HasError).publish_state(false);
                  };
  # --------------------------------------------------------------------------- 
  - id:                                       pageRefresh
    mode:                                     restart
    then:
       if:
        condition:
          - binary_sensor.is_off:             deviceShowWelcome
        then:
          - lambda: |-
              static script::Script<> *scripts[]  = {id(pageBuild1), id(pageBuild2), id(pageBuild3)};
              int current_page = id(pageCurrent).state;
              scripts[current_page]->execute();
  # ---------------------------------------------------------------------------
  - id:                                       pageBuild1
    mode:                                     restart
    then:
      - lambda: |-
          int xWidth =              display->tft.width();
          int yHeight =             display->tft.height();
          int xCenter =             xWidth / 2;
          int yHLine =              34;                                                    // Vertical position of horizontal line
          int yColHeaderCenter =    yHLine + 15;
          
          int xLoffset =            10;
          int xRoffset =            310;
          int xCol1Center =         80;
          int xCol2Center =         240;
          int xCRoffset =           xCenter + 10;
          int xCLoffset =           xCenter - 10;
          int colYOffset =          40; 

          float level1 =            id(sensor1LPLevel).state;
          float level2 =            id(sensor2LPLevel).state;
         
          //**********************************************************************************
          //  Build common page layout - two rows
              display->tft.fillScreen(TFT_BLACK);
              display->tft.setRotation(1);
              display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
              display->tft.drawRoundRect(0, 0, xWidth, yHeight, 10, TFT_RED);
              display->tft.drawFastHLine(0, yHLine, xWidth, TFT_RED);
              display->tft.setFreeFont(FMB12);
              display->tft.setTextDatum(MC_DATUM);

          // *** If a 2 column page, draw vertical line ***
              display->tft.drawFastVLine(160, 35, 135, TFT_RED);   

          // Display page1 title
            display->tft.drawString("${sub_page1_title}",xCenter, yHLine / 2);

          // If there is an error on sensor 1, display error indicator
            display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
            display->tft.drawString("${sub_sensor1_name}",xCol1Center ,yColHeaderCenter);
            if (id(sensor1HasError).state == true) {
              display->tft.setFreeFont(FSB9);
              display->tft.setTextColor(TFT_WHITE, TFT_RED);
              display->tft.fillCircle(xCLoffset - 5,colYOffset +10,10, TFT_RED);
              display->tft.drawString("!",xCLoffset - 5,colYOffset +10); 
              display->tft.setFreeFont(FMB12);
              
            }
            

          // If there is an error on sensor 2, display error indicator
            display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
            display->tft.drawString("${sub_sensor2_name}",xCol2Center,yColHeaderCenter);
            if (id(sensor2HasError).state == true) {
              display->tft.setTextColor(TFT_WHITE, TFT_RED);
              display->tft.fillCircle(xRoffset - 5,colYOffset +10,10, TFT_RED);
              display->tft.setFreeFont(FSB9);
              display->tft.drawString("!",xRoffset - 5,colYOffset +10); 
              display->tft.setFreeFont(FMB12);
            }
             

          // Build the Col1 Sensor background color
              display->tft.setFreeFont(FSB24);
              display->tft.setTextColor(TFT_BLACK, id(sensor1LvlBGColor).state);
              display->tft.fillRoundRect(xLoffset + 5, colYOffset + 30, 126, 90, 10, id(sensor1LvlBGColor).state);

          // Display sensor 1 level value
              display->tft.setTextDatum(ML_DATUM);
              display->tft.drawString("%", xCol1Center + 15, 110);   
              display->tft.setTextDatum(MR_DATUM); 
              if (level1 <= 100 && level1 >= 0) {
                display->tft.drawFloat(level1,0, xCol1Center +14, 110);
              } else {
                display->tft.drawString("--",  xCol1Center +14, 110);
              }

          // Build the Col2 Sensor background color
            display->tft.setFreeFont(FSB24);
            display->tft.setTextColor(TFT_BLACK, id(sensor2LvlBGColor).state);
            display->tft.fillRoundRect(xCRoffset + 5, colYOffset + 30, 126,  90, 10, id(sensor2LvlBGColor).state);

          // Display sensor 1 level value
            display->tft.setTextDatum(ML_DATUM);  
            display->tft.drawString("%", xCol2Center + 15, 110);
            display->tft.setTextDatum(MR_DATUM); 
            if (level2 <= 100 && level2 >= 0) {
              display->tft.drawFloat(level2,0, xCol2Center + 14, 110);
            } else {
              display->tft.drawString("--",  xCol2Center + 14, 110);
            }
  # ---------------------------------------------------------------------------
  - id:                                       pageBuild2
    mode:                                     restart
    then:
      - lambda: |-
          int xWidth =              display->tft.width();
          int yHeight =             display->tft.height();
          int xCenter =             xWidth / 2;
          int yHLine =              34;     
          int yColHeaderCenter =    yHLine + 15;

          int lineYoffset =         20;
          int yLine1 =              75;
          int yLine2 =              yLine1 + lineYoffset;
          int yLine3 =              yLine2 + lineYoffset;
          int yLine4 =              yLine3 + lineYoffset;
          int yLine5 =              yLine4 + lineYoffset; 
          
          int xLoffset =            10;
          int xRoffset =            310;
          int xCol1Center =         80;
          int xCol2Center =         240;
          int xCRoffset =           xCenter + 10;
          int xCLoffset =           xCenter - 10;
          int colYOffset =          40; 

          float batt1 =             id(sensor1Batt).state;
          float batt2 =             id(sensor2Batt).state;
          float btsignal1 =         id(sensor1BTSignal).state;
          float btsignal2 =         id(sensor2BTSignal).state;
          float level1 =            id(sensor1LPLevel).state;
          float level2 =            id(sensor2LPLevel).state;
          float temp1 =             id(sensor1Temp).state;
          float temp2 =             id(sensor2Temp).state;

          //  Build common page layout - two rows
              display->tft.fillScreen(TFT_BLACK);
              display->tft.setRotation(1);
              display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
              display->tft.drawRoundRect(0, 0, xWidth, yHeight, 10, TFT_RED);
              display->tft.drawFastHLine(0, yHLine, xWidth, TFT_RED);
              display->tft.setFreeFont(FMB12);
              display->tft.setTextDatum(MC_DATUM);

          // *** If a 2 column page, draw vertical line ***
              display->tft.drawFastVLine(160, 35, 135, TFT_RED);   

          // Display page2 title
              display->tft.drawString("${sub_page2_title}",xCenter, yHLine / 2);       

          // Print page and column headers
              display->tft.drawString("${sub_sensor1_name}",xCol1Center ,yColHeaderCenter);
              display->tft.drawString("${sub_sensor2_name}",xCol2Center,yColHeaderCenter); 

          // print MAC address under sensor name
              display->tft.setFreeFont(FS9);
              display->tft.drawString("${sub_sensor1_mac}",xCol1Center, yLine1);
              display->tft.drawString("${sub_sensor2_mac}",xCol2Center, yLine1);
          
          // Column 1
            // Attribute Labels - each is inside a black rectangle we can change the color of in case of error
                display->tft.setFreeFont(FS9);
            // Build the column 1 "BT Signal" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.setTextColor(TFT_WHITE, id(sensor1BTSignalBGColor).state);
                display->tft.fillRoundRect(5, yLine2 - 8, 151, 20, 5, id(sensor1BTSignalBGColor).state);
                display->tft.drawString("BT Signal:", xLoffset, yLine2);
                display->tft.setTextDatum(MR_DATUM);
                if (btsignal1 != -99) {
                  display->tft.drawFloat(btsignal1,0, xCLoffset-37, yLine2); 
                } else {
                  display->tft.drawString("--", xCLoffset-37, yLine2); 
                }
                display->tft.drawString("dBm", xCLoffset, yLine2); 
                display->tft.setTextColor(TFT_WHITE, TFT_BLACK);   

            // Build the column 1 "Battery" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.setTextColor(TFT_WHITE, id(sensor1BattBGColor).state);
                display->tft.fillRoundRect(5, yLine3 - 8, 151, 20, 5, id(sensor1BattBGColor).state); 
                display->tft.drawString("Battery:", xLoffset, yLine3);
                display->tft.setTextDatum(MR_DATUM);
                if (batt1 != -99) {
                  display->tft.drawFloat(batt1,0, xCLoffset-17, yLine3); 
                } else {
                  display->tft.drawString("--", xCLoffset-17, yLine3); 
                }
                display->tft.drawString("%", xCLoffset, yLine3); 
                display->tft.setTextColor(TFT_WHITE, TFT_BLACK);       
              
            // Build the column 1 "Temp" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.drawString("Temp:", xLoffset, yLine4);
                display->tft.setTextDatum(MR_DATUM);
                display->tft.drawString("°F", xCLoffset, yLine4);
                if ((temp1 != -99) ){
                  display->tft.drawFloat(temp1, 0, xCLoffset-17, yLine4);
                } else {
                  display->tft.drawString("--", xCLoffset-17, yLine4);
                }

              // Build the column 1 "Level" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.drawString("Level:", xLoffset, yLine5); 
                display->tft.setTextDatum(MR_DATUM);
                display->tft.drawString("%", xCLoffset, yLine5);
                if (level1 <= 100 && level1 >= 0) {
                  display->tft.drawFloat(level1,0, xCLoffset-17, yLine5); 
                } else  {
                  display->tft.drawString("--", xCLoffset-17, yLine5); 
                }

          // Column 2
            // Attribute Labels - each is inside a black rectangle we can change the color of in case of error
                display->tft.setFreeFont(FS9);
            // Build the column 2 "BT Signal" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.setTextColor(TFT_WHITE, id(sensor2BTSignalBGColor).state);
                display->tft.fillRoundRect(xCenter + 5, yLine2 - 8, 151, 20, 5, id(sensor2BTSignalBGColor).state);
                display->tft.drawString("BT Signal:", xCRoffset, yLine2);
                display->tft.setTextDatum(MR_DATUM);
                //display->tft.drawFloat(btsignal2,0, xRoffset-37, yLine2); 
                if (btsignal2 != -99) {
                  display->tft.drawFloat(btsignal2,0, xRoffset-37, yLine2); 
                } else {
                  display->tft.drawString("--", xRoffset-37, yLine2); 
                }
                display->tft.drawString("dBm", xRoffset, yLine2); 
                display->tft.setTextColor(TFT_WHITE, TFT_BLACK); 
            
            // Build the column 2 "Battery" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.setTextColor(TFT_WHITE, id(sensor2BattBGColor).state);
                display->tft.fillRoundRect(xCenter + 5, yLine3 - 8, 151, 20, 5, id(sensor2BattBGColor).state); 
                display->tft.drawString("Battery:", xCRoffset, yLine3);
                display->tft.setTextDatum(MR_DATUM);
                display->tft.drawString("%", xRoffset, yLine3); 
                if (batt2 != -99) {
                  display->tft.drawFloat(batt2,0, xRoffset-17, yLine3); 
                } else {
                  display->tft.drawString("--", xRoffset-17, yLine3); 
                }
                
                display->tft.setTextColor(TFT_WHITE, TFT_BLACK);  

            // Build the column 2 "Temp" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.drawString("Temp:", xCRoffset, yLine4);
                display->tft.setTextDatum(MR_DATUM);
                display->tft.drawString("°F", xRoffset, yLine4);
                if (temp2 != -99) {
                  display->tft.drawFloat(temp2, 0, xRoffset-17, yLine4);
                } else {
                  display->tft.drawString("--", xRoffset-17, yLine4);
                }

            // Build the column 2 "Level" line
                display->tft.setTextDatum(ML_DATUM);
                display->tft.drawString("Level:", xCRoffset, yLine5);
                display->tft.setTextDatum(MR_DATUM);
                display->tft.drawString("%", xRoffset, yLine5);
                if (level2 != -99) {
                  display->tft.drawFloat(level2,0, xRoffset-17, yLine5); 
                } else  {
                  display->tft.drawString("--", xRoffset-17, yLine5); 
                }
  # ---------------------------------------------------------------------------
  - id:                                       pageBuild3
    mode:                                     restart
    then:
      - lambda: |-
          int yLine0 =              48;
          int yLine1 =              68;
          int yLine2 =              88;
          int yLine3 =              108;
          int yLine4 =              128;
          int yLine5 =              148;
          int yHLine =              35;
          int xCenter =             160;
          int xLoffset =            10;
          int xRoffset =            310;
          int xCol1Center =         80;
          int xCol2Center =         240;
          int xCRoffset =           xCenter - 10;
          int xCLoffset =           xCenter + 10;
          int colYOffset =          40;

          display->tft.fillScreen(TFT_BLACK);
          display->tft.setRotation(1);
          display->tft.drawRoundRect(0, 0, 320, 170, 10, TFT_RED);       
          display->tft.drawFastHLine(0, yHLine, 320, TFT_RED);

          display->tft.setFreeFont(FMB12);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
          display->tft.drawString("Network Info",160, 10);
          display->tft.setTextDatum(TL_DATUM);
          display->tft.setFreeFont(FMB9);
          display->tft.drawString("MAC Addr:",xLoffset,yLine0);
          display->tft.drawString("WiFi Network:",xLoffset,yLine1);
          display->tft.drawString("WiFi Strength:",xLoffset,yLine2);
          display->tft.drawString("IP Address:",xLoffset,yLine3);
          display->tft.drawString("Uptime:",xLoffset,yLine4);
          display->tft.drawString("Code Version:",xLoffset,yLine5);
          
          display->tft.setTextDatum(TR_DATUM);
          display->tft.drawString(id(host_mac).state.c_str(),xRoffset, yLine0);
          if (!wifi::global_wifi_component->is_connected()) {
            display->tft.drawString("Not Connected",xRoffset, yLine1);
            display->tft.drawString("Not Connected",xRoffset, yLine2);
            display->tft.drawString("Not Connected",xRoffset, yLine3);
          } else {
            display->tft.drawString(id(host_ssid).state.c_str(),xRoffset, yLine1);
            display->tft.drawString("dBm",xRoffset, yLine2);
            display->tft.drawFloat(id(${sub_esphome_name}_wifi_signal).state,0,xRoffset - 37, yLine2);
            display->tft.drawString(id(host_ip).state.c_str(),xRoffset,yLine3);
          }

          
          display->tft.drawString(id(uptime_f).state.c_str(),xRoffset,yLine4);
          display->tft.drawString(id(codeVersion).state.c_str(),xRoffset,yLine5);
  # ---------------------------------------------------------------------------
  - id:                                       pageWelcome
    mode:                                     restart
    then:
      - logger.log:                 "Running Welcome Page"
      - lambda: |-
          int xWidth =              display->tft.width();
          int yHeight =             display->tft.height();
          int xCenter =             160; //xWidth / 2;
          int yCenter =             yHeight / 2;
          int yLine0 =              48;
          int yLine1 =              68;
          int yLine2 =              88;
          int yLine3 =              108;
          int yLine4 =              128;
          int yLine5 =              148;
          int yHLine =              35;
          int xLoffset =            10;
          int xRoffset =            310;
          int xCol1Center =         80;
          int xCol2Center =         240;
          int xCRoffset =           xCenter - 10;
          int xCLoffset =           xCenter + 10;
          int colYOffset =          40;

          display->spr.setTextSize(3);
          display->tft.fillScreen(TFT_BLACK);
          display->tft.setRotation(1);
          display->tft.drawRoundRect(0, 0, 320, 170, 10, TFT_RED);       
          display->tft.drawFastHLine(0, yHLine, 320, TFT_RED);

          display->tft.setFreeFont(FMB12);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
          display->tft.drawString("Welcome",160, 10);
          display->tft.setTextDatum(MC_DATUM);
          display->tft.setFreeFont(FM9);
          display->tft.drawString("For more information,",xCenter,yLine0);
          display->tft.drawString("support, or suggestions",xCenter,yLine1);
          display->tft.drawString("please visit the Github",xCenter,yLine2);
          display->tft.drawString("project page at:",xCenter,yLine3);
          display->tft.drawString("http://bit.ly/MopekaDisplay",xCenter,yLine5);
          //
      - delay:      5s
      - globals.set:
          id: displayWelcome
          value: 'false'
  # ---------------------------------------------------------------------------
  - id:                                       displayRotationStatus
    then:
      - lambda: |-
          int xCenter = 160;
          int yCenter = 85;
          int yHLine = 35;

          display->tft.fillScreen(TFT_BLACK);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
          display->tft.setRotation(1);
          display->tft.drawRoundRect(0, 0, 320, 170, 10, TFT_RED);
          display->tft.drawFastHLine(0, yHLine, 320, TFT_RED);

          display->tft.setFreeFont(FMB12);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);

          display->tft.drawString("Settings",160, 10);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setFreeFont(FMB12);
          
          display->tft.drawString("Screen Rotation is",xCenter,yCenter-30);
          display->tft.setFreeFont(FMB24);
          if (id(refreshEnabled).state == true) {
            display->tft.drawString("ENABLED",xCenter,yCenter);
          } else {
            display->tft.drawString("DISABLED",xCenter,yCenter);
          }
  # ---------------------------------------------------------------------------
  - id:                                       displayScreensaverStatus
    then:
      - lambda: |-
          int xCenter = 160;
          int yCenter = 85;
          int yHLine =  35;

          display->tft.fillScreen(TFT_BLACK);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);
          display->tft.setRotation(1);
          display->tft.drawRoundRect(0, 0, 320, 170, 10, TFT_RED);
          display->tft.drawFastHLine(0, yHLine, 320, TFT_RED);


          display->tft.setFreeFont(FMB12);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setTextColor(TFT_WHITE, TFT_BLACK);

          display->tft.drawString("Settings",160, 10);
          display->tft.setTextDatum(TC_DATUM);
          display->tft.setFreeFont(FMB12);
          
          display->tft.drawString("Screen Saver is",xCenter,yCenter-30);
          display->tft.setFreeFont(FMB24);
          if (id(screensaver).state == true) {
            display->tft.drawString("ENABLED",xCenter,yCenter);
          } else {
            display->tft.drawString("DISABLED",xCenter,yCenter);
          }

#*****************************************************************************#
# Switches 
switch:
  - platform:                                 gpio
    pin:                                      GPIO38
    name:                                     ${sub_text_devicename} Device Backlight
    id:                                       backlight
    icon:                                     mdi:lightbulb
    restore_mode:                             RESTORE_DEFAULT_ON
  # ----------------------------------------------------------------
  - id:                                       refreshEnabled
    platform:                                 template
    name:                                     ${sub_text_devicename} Device Auto Scroll
    restore_state:                            true
    optimistic:                               true
  # ----------------------------------------------------------------
  - id:                                       screensaver
    platform:                                 template
    name:                                     ${sub_text_devicename} Device Screensaver Mode
    restore_state:                            true
    optimistic:                               true

#*****************************************************************************#
#  Text-Sensors 
text_sensor:
  - id:                                       codeVersion
    platform:                                 template
    name:                                     ${sub_text_devicename} Device Code Version
    entity_category:                          diagnostic
  # ----------------------------------------------------------------
  - id:                                       sensor1MACAddress
    platform:                                 template
    name:                                     ${sub_text_devicename} ${sub_sensor1_name} Address
    entity_category:                          diagnostic
    icon:                                     mdi:fingerprint
  # ----------------------------------------------------------------
  - id:                                       sensor2MACAddress
    platform:                                 template
    name:                                     ${sub_text_devicename} ${sub_sensor2_name} Address
    entity_category:                          diagnostic
    icon:                                     mdi:fingerprint
  # ----------------------------------------------------------------
  - platform:                                 wifi_info             
    ip_address:
      name:                                   ${sub_text_devicename} Device IP Address
      id:                                     host_ip
      entity_category:                        diagnostic
      icon:                                   mdi:fingerprint
    ssid:
      name:                                   ${sub_text_devicename} Device WiFi SSID
      id:                                     host_ssid
      entity_category:                        diagnostic
      icon:                                   mdi:router-wireless
    mac_address:
      id:                                     host_mac
      name:                                   ${sub_text_devicename} Device MAC Address
      entity_category:                        diagnostic
      icon:                                   mdi:fingerprint
  # ----------------------------------------------------------------
  - id:                                       uptime_f
    platform:                                 template
    name:                                     "Uptime"
    internal:                                 true
    lambda: |-
              uint32_t dur = id(uptime_s).state;
              int dys = 0;
              int hrs = 0;
              int mnts = 0;
              if (dur > 86399) {
                dys = trunc(dur / 86400);
                dur = dur - (dys * 86400);
              }
              if (dur > 3599) {
                hrs = trunc(dur / 3600);
                dur = dur - (hrs * 3600);
              }
              if (dur > 59) {
                mnts = trunc(dur / 60);
                dur = dur - (mnts * 60);
              }
              char buffer[17];
              sprintf(buffer, "%ud %02uh %02um %02us", dys, hrs, mnts, dur);
              return {buffer};
    icon:                                     mdi:clock-start
    update_interval:                          10s